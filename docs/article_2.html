<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Androidè¿›ç¨‹ä¿æ´»ç»ˆææ–¹æ¡ˆï¼šä»Frameworkå±‚å®ç°æ°¸ç”Ÿä¸æ­»</title>
    <link rel="stylesheet" href="https://unpkg.com/normalize.css/normalize.css">
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        :root {
            color-scheme: dark;
            --color-bg-deep: #05070d;
            --color-bg-gradient-start: #090d16;
            --color-text-light: #d9e6ff;
            --color-text-sky: #8bc8ff;
            --color-text-cyan: #38e4d8;
            --color-card-bg: rgba(10, 18, 32, 0.78);
            --color-card-border: rgba(63, 101, 152, 0.35);
            --color-nav-bg: rgba(7, 12, 22, 0.9);
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: radial-gradient(circle at center, var(--color-bg-gradient-start), var(--color-bg-deep) 75%);
            color: var(--color-text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        a {
            color: inherit;
            text-decoration: none;
            transition: color 0.25s ease;
        }

        /* ==================== å­—æ¯é›¨èƒŒæ™¯ ==================== */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.4;
        }

        /* ==================== å¯¼èˆªæ  ==================== */
        .brand {
            padding: 36px 24px 16px;
            text-align: center;
            letter-spacing: 0.4em;
            position: relative;
            z-index: 10;
        }

        .brand h1 {
            margin: 0;
            font-size: 32px;
            color: var(--color-text-sky);
            text-shadow: 0 0 15px currentColor, 0 0 30px currentColor, 0 0 45px currentColor;
            font-weight: 600;
        }

        .nav {
            display: flex;
            gap: 12px;
            justify-content: center;
            padding: 16px 24px 22px;
            position: sticky;
            top: 0;
            background: var(--color-nav-bg);
            backdrop-filter: blur(14px);
            z-index: 10;
            border-bottom: 1px solid rgba(139, 200, 255, 0.1);
        }

        .nav a {
            padding: 10px 22px;
            border-radius: 999px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.82);
            transition: all 0.25s ease;
            font-weight: 500;
        }

        .nav a:hover {
            color: #ffffff;
            background: rgba(139, 200, 255, 0.1);
        }

        .nav a.active {
            color: #04121c;
            background: linear-gradient(135deg, #7bd0ff, #38e4d8);
            box-shadow: 0 10px 26px rgba(78, 208, 223, 0.32);
            font-weight: 600;
        }

        /* ==================== å®¹å™¨ ==================== */
        .container {
            max-width: 980px;
            margin: 32px auto;
            padding: 0 20px;
            position: relative;
            z-index: 1;
        }

        /* ==================== å¡ç‰‡ ==================== */
        .card {
            background: var(--color-card-bg);
            border: 1px solid var(--color-card-border);
            border-radius: 16px;
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: 0 12px 35px rgba(9, 18, 33, 0.45);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 45px rgba(9, 18, 33, 0.6);
        }

        /* ==================== æŒ‰é’® ==================== */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 22px;
            border-radius: 32px;
            background: linear-gradient(135deg, #78d7ff, #2ed6b5);
            color: #071522;
            font-weight: 600;
            letter-spacing: 0.08em;
            transition: all 0.25s ease;
            border: none;
            cursor: pointer;
            text-shadow: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(78, 212, 220, 0.32);
        }

        /* ==================== æ ‡ç­¾ ==================== */
        .tag {
            display: inline-block;
            padding: 4px 12px;
            margin: 4px;
            border-radius: 12px;
            background: rgba(139, 200, 255, 0.1);
            color: var(--color-text-sky);
            font-size: 13px;
            border: 1px solid rgba(139, 200, 255, 0.2);
            transition: all 0.2s ease;
        }

        .tag:hover {
            background: rgba(139, 200, 255, 0.2);
            border-color: rgba(139, 200, 255, 0.4);
        }

        /* ==================== é¡µè„š ==================== */
        footer {
            padding: 40px 20px;
            text-align: center;
            font-size: 13px;
            opacity: 0.6;
            position: relative;
            z-index: 1;
        }

        /* ==================== å“åº”å¼ ==================== */
        @media (max-width: 768px) {
            .brand h1 {
                font-size: 24px;
                letter-spacing: 0.3em;
            }

            .nav {
                gap: 8px;
                padding: 12px 16px;
            }

            .nav a {
                padding: 8px 16px;
                font-size: 13px;
            }

            .container {
                padding: 0 16px;
                margin: 20px auto;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- å­—æ¯é›¨èƒŒæ™¯ -->
    <canvas id="matrix-canvas"></canvas>

    <!-- å¯¼èˆªæ  -->
    <div class="brand">
        <h1>ç›˜å¤å¤§ä»™æ´åºœ</h1>
    </div>
    <nav class="nav">
        
        <a href="index.html" class="">é¦–é¡µ</a>
        <a href="list.html" class="active">åŠ¨æ€</a>
        <a href="about.html" class="">å…³äºä½œè€…</a>
        
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        
<style>
    /* ==================== æ–‡ç« è¯¦æƒ…æ ·å¼ ==================== */
    .detail-wrapper {
        max-width: 1024px;
        margin: 0 auto;
        padding: 0 20px 80px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--color-text-sky);
        font-size: 14px;
        margin-bottom: 32px;
        transition: color 0.2s ease;
    }

    .back-link:hover {
        color: var(--color-text-cyan);
    }

    .back-link svg {
        width: 16px;
        height: 16px;
    }

    .article-container {
        background: var(--color-card-bg);
        border: 1px solid var(--color-card-border);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 12px 40px rgba(9, 18, 33, 0.5);
        margin-bottom: 32px;
        backdrop-filter: blur(14px);
    }

    .article-cover {
        width: 100%;
        height: 320px;
        object-fit: cover;
    }

    .article-body {
        padding: 32px;
    }

    .article-header {
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(139, 200, 255, 0.1);
    }

    .article-title {
        font-size: clamp(28px, 5vw, 38px);
        font-weight: 700;
        color: var(--color-text-sky);
        margin: 0 0 20px;
        line-height: 1.3;
    }

    .article-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 14px;
        opacity: 0.75;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .meta-item svg {
        width: 16px;
        height: 16px;
    }

    .article-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }

    /* ==================== æ–‡ç« å†…å®¹æ ·å¼ ==================== */
    .article-content {
        line-height: 1.85;
        color: #e6edf7;
        font-size: 16px;
    }

    .article-content h1, .article-content h2, .article-content h3,
    .article-content h4, .article-content h5, .article-content h6 {
        color: var(--color-text-sky);
        margin-top: 32px;
        margin-bottom: 16px;
        font-weight: 600;
    }

    .article-content h1 { font-size: 32px; }
    .article-content h2 { font-size: 28px; }
    .article-content h3 { font-size: 24px; }
    .article-content h4 { font-size: 20px; }

    .article-content p {
        margin: 16px 0;
    }

    .article-content a {
        color: var(--color-text-sky);
        text-decoration: none;
        border-bottom: 1px solid rgba(139, 200, 255, 0.3);
        transition: all 0.2s ease;
    }

    .article-content a:hover {
        color: var(--color-text-cyan);
        border-bottom-color: var(--color-text-cyan);
    }

    .article-content code {
        background: rgba(110, 118, 129, 0.4);
        border-radius: 4px;
        padding: 2px 8px;
        font-family: 'JetBrains Mono', 'SFMono-Regular', 'Menlo', monospace;
        font-size: 14px;
    }

    .article-content pre {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 12px;
        padding: 20px;
        overflow-x: auto;
        margin: 24px 0;
    }

    .article-content pre code {
        background: none;
        padding: 0;
        font-size: 14px;
        line-height: 1.6;
    }

    .article-content blockquote {
        border-left: 4px solid var(--color-text-sky);
        padding-left: 20px;
        margin: 24px 0;
        color: #8b949e;
        font-style: italic;
    }

    .article-content ul, .article-content ol {
        padding-left: 28px;
        margin: 16px 0;
    }

    .article-content li {
        margin: 10px 0;
    }

    .article-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 24px 0;
        border: 1px solid var(--color-card-border);
        border-radius: 8px;
        overflow: hidden;
    }

    .article-content th,
    .article-content td {
        border: 1px solid var(--color-card-border);
        padding: 12px 16px;
        text-align: left;
    }

    .article-content th {
        background: rgba(139, 200, 255, 0.1);
        font-weight: 600;
        color: var(--color-text-sky);
    }

    .article-content img {
        max-width: 100%;
        border-radius: 12px;
        margin: 24px 0;
    }

    /* ==================== å“åº”å¼ ==================== */
    @media (max-width: 768px) {
        .detail-wrapper {
            padding-bottom: 60px;
        }

        .article-cover {
            height: 220px;
        }

        .article-body {
            padding: 24px 20px;
        }

        .article-title {
            font-size: 24px;
        }

        .article-content h1 { font-size: 26px; }
        .article-content h2 { font-size: 22px; }
        .article-content h3 { font-size: 20px; }
        .article-content h4 { font-size: 18px; }
    }
</style>

<div class="detail-wrapper">
    <!-- è¿”å›æŒ‰é’® -->
    
    <a href="list.html" class="back-link">
    
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        è¿”å›åˆ—è¡¨
    </a>

    <!-- æ–‡ç« å†…å®¹ -->
    <article class="article-container">
        

        <div class="article-body">
            <header class="article-header">
                <h1 class="article-title">Androidè¿›ç¨‹ä¿æ´»ç»ˆææ–¹æ¡ˆï¼šä»Frameworkå±‚å®ç°æ°¸ç”Ÿä¸æ­»</h1>
                <div class="article-meta">
                    <div class="meta-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>2025-11-21 21:16</span>
                    </div>
                    
                    <div class="meta-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        <div class="article-tags">
                            
                            <span class="tag">Android</span>
                            
                            <span class="tag">Binder</span>
                            
                            <span class="tag">Framework</span>
                            
                            <span class="tag">JNI</span>
                            
                            <span class="tag">Nativeå¼€å‘</span>
                            
                            <span class="tag">è¿›ç¨‹ä¿æ´»</span>
                            
                            <span class="tag">é»‘ç§‘æŠ€</span>
                            
                        </div>
                    </div>
                    
                </div>
            </header>

            <div class="article-content">
                <h1>Androidè¿›ç¨‹ä¿æ´»ç»ˆææ–¹æ¡ˆï¼šä»Frameworkå±‚å®ç°æ°¸ç”Ÿä¸æ­»</h1>
<blockquote>
<p>æœ¬æ–‡æ·±å…¥å‰–æAndroid 4.0-13å…¨ç‰ˆæœ¬è¦†ç›–çš„è¿›ç¨‹ä¿æ´»é»‘ç§‘æŠ€ï¼ŒåŸºäºFrameworkå±‚æ”¹é€ å®ç°è¶…å¼ºä¿æ´»èƒ½åŠ›ï¼Œæ”¯æŒå…¨å“ç‰Œæœºå‹ã€‚</p>
</blockquote>
<h2>æŠ€æœ¯æ–¹æ¡ˆæ¦‚è¿°</h2>
<p>ä¸åŒäºä¸€åƒç´ ä¿æ´»ã€åŒè¿›ç¨‹ä¿æ´»ç­‰ä¼ ç»Ÿå¼±é¸¡ä¿æ´»æ‰‹æ®µï¼Œæœ¬æ–¹æ¡ˆä»<strong>Linuxã€Frameworkã€Native</strong>ä¸‰ä¸ªå±‚æ¬¡å®ç°è¿›ç¨‹å®ˆæŠ¤ï¼Œå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›:</p>
<h3>æ ¸å¿ƒç‰¹æ€§</h3>
<ul>
<li>âœ… <strong>æ— éœ€ä»»ä½•æƒé™</strong>ï¼šä¸ä¾èµ–ç™½åå•ã€ç”µæ± ä¼˜åŒ–ç­‰æƒé™</li>
<li>âœ… <strong>ç”¨æˆ·æ— æ„ŸçŸ¥</strong>ï¼šé€šçŸ¥æ å¯å®Œå…¨éšè—ï¼Œç”¨æˆ·æ— æ„Ÿ</li>
<li>âœ… <strong>å…¨ç‰ˆæœ¬æ”¯æŒ</strong>ï¼šAndroid 4.0 - Android 13 å…¨è¦†ç›–</li>
<li>âœ… <strong>å…¨å“ç‰Œå…¼å®¹</strong>ï¼šåä¸ºã€å°ç±³ã€OPPOã€VIVOã€ä¸‰æ˜Ÿã€é­…æ—ç­‰98%ä»¥ä¸Šæœºå‹</li>
<li>âœ… <strong>å¼€æœºè‡ªå¯</strong>ï¼šç³»ç»Ÿå¯åŠ¨è‡ªåŠ¨æ‹‰æ´»</li>
<li>âœ… <strong>å®‰è£…è‡ªå¯</strong>ï¼šåº”ç”¨å®‰è£…åè‡ªåŠ¨å¯åŠ¨</li>
<li>âœ… <strong>åå°æ‹‰æ´»</strong>ï¼šè¿›ç¨‹è¢«æ€åç§’çº§æ‹‰æ´»</li>
<li>âœ… <strong>è¿›ç¨‹å®ˆæŠ¤</strong>ï¼šæ°¸ç”Ÿä¸æ­»ã€æ­»åæ‹‰æ´»</li>
</ul>
<h2>ä¿æ´»æŠ€æœ¯åŸç†</h2>
<h3>1. æ–‡ä»¶é”æœºåˆ¶</h3>
<p>æ ¸å¿ƒæ€è·¯æ˜¯åˆ©ç”¨Linuxæ–‡ä»¶è¿›ç¨‹åŒæ­¥æœºåˆ¶ï¼š</p>
<ul>
<li>è¿›ç¨‹Aç»™æ–‡ä»¶A1åŠ é”ï¼Œè¿›ç¨‹Bç»™æ–‡ä»¶B1åŠ é”</li>
<li>è¿›ç¨‹Aé˜»å¡è¯»å–B1æ–‡ä»¶ï¼Œè¿›ç¨‹Bé˜»å¡è¯»å–A1æ–‡ä»¶</li>
<li>å½“ä»»ä¸€è¿›ç¨‹æŒ‚æ‰ï¼Œå…¶æ–‡ä»¶é”è‡ªåŠ¨é‡Šæ”¾</li>
<li>å¦ä¸€è¿›ç¨‹æ£€æµ‹åˆ°æ–‡ä»¶é”é‡Šæ”¾ï¼Œç«‹å³æ‹‰æ´»å¯¹æ–¹</li>
</ul>
<p><strong>å…³é”®ç‚¹</strong>ï¼šJavaå±‚æ— æ³•å®ç°ï¼Œå¿…é¡»ä½¿ç”¨Cåœ¨Nativeå±‚å®Œæˆã€‚</p>
<h3>2. å¿«é€Ÿå¯åŠ¨ä¼˜åŒ–</h3>
<p>ç³»ç»Ÿæ€æ­»è¿›ç¨‹æ—¶é—´æçŸ­(å‡ åæ¯«ç§’)ï¼Œå¸¸è§„Intentå‘é€éœ€è¦ç™¾æ¯«ç§’ï¼Œéš¾ä»¥åœ¨è¿›ç¨‹è¢«æ€å‰å®Œæˆã€‚</p>
<p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong>ï¼š</p>

<pre><code>// é¢„å…ˆåˆ›å»ºParcelï¼Œé¿å…ä¸´æ—¶åˆ›å»ºçš„æ—¶é—´æ¶ˆè€—
p = Parcel.obtain();
p.writeInterfaceToken(&quot;android.app.IActivityManager&quot;);
p.writeStrongBinder(null);
if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {
    p.writeInt(1);
}
entity.intent.writeToParcel(p, 0);
p.writeString(null);
if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {
    p.writeInt(0);
}
if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
    p.writeString(entity.intent.getComponent().getPackageName());
}
p.writeInt(0);
</code></pre>

<h3>3. åå°„è·å–Binder</h3>
<p>é€šè¿‡åå°„ç›´æ¥è·å–ActivityManagerServiceçš„Binderä»£ç†ï¼š</p>

<pre><code>try {
    Class&lt;?&gt; cls = Class.forName(&quot;android.app.ActivityManagerNative&quot;);
    Object invoke = cls.getMethod(&quot;getDefault&quot;, new Class[0]).invoke(null, new Object[0]);
    Field field = invoke.getClass().getDeclaredField(&quot;mRemote&quot;);
    field.setAccessible(true);
    binder = (IBinder) field.get(invoke);
    field.setAccessible(false);
    Logger.v(Logger.TAG, &quot;initAmsBinder: mRemote == iBinder &quot; + binder);
} catch (Throwable th) {
    binderManager.thrown(th);
}

if (binder == null) {
    try {
        binder = (IBinder) Class.forName(&quot;android.os.ServiceManager&quot;)
                .getMethod(&quot;getService&quot;, new Class[]{String.class})
                .invoke(null, new Object[]{&quot;activity&quot;});
    } catch (Throwable th) {
        binderManager.thrown(th);
    }
}
</code></pre>

<h2>æ ¸å¿ƒå®ç°ä»£ç </h2>
<h3>Applicationåˆå§‹åŒ–</h3>
<p>åœ¨Applicationä¸­æ³¨å†Œç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œå¯åŠ¨ä¿æ´»æœåŠ¡ï¼š</p>

<pre><code>public void attach(Context base, Application app) {
    app.registerActivityLifecycleCallbacks(new Application.ActivityLifecycleCallbacks() {

        @Override
        public void onActivityCreated(final Activity activity, Bundle savedInstanceState) {
            Logger.v(Logger.TAG, String.format(&quot;====&gt; [%s] created&quot;, activity.getClass().getSimpleName()));
            ServiceHolder.getInstance().bindService(activity, DaemonService.class,
                new ServiceHolder.OnServiceConnectionListener() {
                    @Override
                    public void onServiceConnection(ServiceConnection connection, boolean isConnected) {
                        if (isConnected) {
                            connCache.put(activity, connection);
                        }
                    }
                });
        }
        // ... å…¶ä»–ç”Ÿå‘½å‘¨æœŸå›è°ƒ
    });
}
</code></pre>

<h3>DaemonServiceæ ¸å¿ƒæœåŠ¡</h3>

<pre><code>public class DaemonService extends DaemonBaseService {

    @Override
    public IBinder onBind(Intent intent) {
        return super.onBind(intent);
    }

    @Override
    public void onCreate() {
        try {
            // å¯åŠ¨å‰å°é€šçŸ¥æœåŠ¡
            ContextCompat.startForegroundService(this,
                new Intent().setClassName(getPackageName(), NotifyResidentService.class.getName()));
        } catch (Throwable th) {
            Logger.e(Logger.TAG, &quot;failed to start foreground service: &quot; + th.getMessage());
        }

        // å¯åŠ¨è¾…åŠ©æœåŠ¡1
        Intent intent2 = new Intent();
        intent2.setClassName(getPackageName(), AssistService1.class.getName());
        startService(intent2);

        // å¯åŠ¨è¾…åŠ©æœåŠ¡2
        Intent intent3 = new Intent();
        intent3.setClassName(getPackageName(), AssistService2.class.getName());
        startService(intent3);

        super.onCreate();
    }
}
</code></pre>

<h3>Nativeå±‚å®ˆæŠ¤å®ç°</h3>

<pre><code>JavaDaemon.getInstance().fire(
    base,
    new Intent(base, DaemonService.class),
    new Intent(base, DaemonReceiver.class),
    new Intent(base, DaemonInstrumentation.class)
);
</code></pre>

<p>åˆ›å»ºè¿›ç¨‹å®ˆæŠ¤æ–‡ä»¶ï¼š</p>

<pre><code>private void fire(Context context, DaemonEnv env, String[] strArr) {
    Logger.i(Logger.TAG, &quot;############### daemon fire ###############&quot;);
    Logger.i(Logger.TAG, &quot;env=&quot; + env + &quot;, strArr=&quot; + Arrays.toString(strArr));

    boolean z;
    String processName = Utils.getProcessName();
    Logger.e(Logger.TAG, &quot;processName: &quot; + processName);

    if (processName.startsWith(context.getPackageName()) &amp;&amp; processName.contains(&quot;:&quot;)) {
        String substring = processName.substring(processName.lastIndexOf(&quot;:&quot;) + 1);
        List&lt;String&gt; list = new ArrayList();

        if (strArr != null) {
            z = false;
            for (String str : strArr) {
                if (str.equals(substring)) {
                    z = true;
                } else {
                    list.add(str);
                }
            }
        } else {
            z = false;
        }

        if (z) {
            Logger.v(Logger.TAG, &quot;app lock file start: &quot; + substring);
            NativeKeepAlive.lockFile(context.getFilesDir() + &quot;/&quot; + substring);
            Logger.v(Logger.TAG, &quot;app lock file finish&quot;);

            String[] strArr2 = new String[list.size()];
            for (int i = 0; i &lt; strArr2.length; i++) {
                strArr2[i] = context.getFilesDir() + &quot;/&quot; + list.get(i);
                Logger.e(Logger.TAG, &quot;processName strarr2: &quot; + strArr2[i]);
            }

            futureScheduler.scheduleFuture(new AppProcessRunnable(env, substring, strArr2));
        }
    }
}
</code></pre>

<h3>é€šè¿‡app_processå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹</h3>

<pre><code>@Override
public void run() {
    DaemonEntity entity = new DaemonEntity();
    entity.str = str;
    entity.strArr = strArr;
    entity.intent = env.intent;
    entity.intent2 = env.intent2;
    entity.intent3 = env.intent3;

    List&lt;String&gt; list = new ArrayList();
    list.add(&quot;export CLASSPATH=$CLASSPATH:&quot; + env.publicSourceDir);

    if (env.nativeLibraryDir.contains(&quot;arm64&quot;)) {
        list.add(&quot;export _LD_LIBRARY_PATH=/system/lib64/:/vendor/lib64/:&quot; + env.nativeLibraryDir);
        list.add(&quot;export LD_LIBRARY_PATH=/system/lib64/:/vendor/lib64/:&quot; + env.nativeLibraryDir);
        list.add(String.format(&quot;%s / %s %s --application --nice-name=%s %s&quot;,
            new Object[]{
                new File(&quot;/system/bin/app_process&quot;).exists() ? &quot;app_process&quot; : &quot;app_process&quot;,
                DaemonMain.class.getName(),
                entity.toString(),
                str
            }));
    } else {
        list.add(&quot;export _LD_LIBRARY_PATH=/system/lib/:/vendor/lib/:&quot; + env.nativeLibraryDir);
        list.add(&quot;export LD_LIBRARY_PATH=/system/lib/:/vendor/lib/:&quot; + env.nativeLibraryDir);
        list.add(String.format(&quot;%s / %s %s --application --nice-name=%s %s&quot;,
            new Object[]{
                new File(&quot;/system/bin/app_process32&quot;).exists() ? &quot;app_process32&quot; : &quot;app_process&quot;,
                DaemonMain.class.getName(),
                entity.toString(),
                str
            }));
    }

    Logger.i(Logger.TAG, &quot;cmds: &quot; + list);
    File file = new File(&quot;/&quot;);
    String[] strArr = new String[list.size()];
    for (int i = 0; i &lt; strArr.length; i++) {
        strArr[i] = list.get(i);
    }
    ShellExecutor.execute(file, null, strArr);
}
</code></pre>

<h2>DaemonMainå®ˆæŠ¤ä¸»ç±»</h2>
<p>è¿™æ˜¯æ•´ä¸ªä¿æ´»æ–¹æ¡ˆçš„æ ¸å¿ƒç±»ï¼Œè¿è¡Œåœ¨Linuxå±‚ï¼š</p>

<pre><code>public class DaemonMain {
    private IBinderManager binderManager = new IBinderManager();
    public DaemonEntity entity;
    private Parcel p;   // Service Parcel
    private Parcel p2;  // Broadcast Parcel
    private Parcel p3;  // Instrumentation Parcel
    private IBinder binder;
    private static volatile FutureScheduler futureScheduler;

    private DaemonMain(DaemonEntity entity) {
        this.entity = entity;
    }

    public static void main(String[] strArr) {
        if (futureScheduler == null) {
            synchronized (DaemonMain.class) {
                if (futureScheduler == null) {
                    futureScheduler = new SingleThreadFutureScheduler(
                        &quot;daemonmain-holder&quot;,
                        true
                    );
                }
            }
        }

        DaemonEntity entity = DaemonEntity.create(strArr[0]);
        if (entity != null) {
            new DaemonMain(entity).execute();
        }

        Logger.e(Logger.TAG, &quot;DaemonMain.main Process.killProcess&quot; + Process.myPid());
        Process.killProcess(Process.myPid());
    }

    private void execute() {
        try {
            initAmsBinder();
            assembleParcel();
            NativeKeepAlive.nativeSetSid();

            try {
                Logger.v(Logger.TAG, &quot;setArgV0: &quot; + entity.str);
                Process.class.getMethod(&quot;setArgV0&quot;, new Class[]{String.class})
                    .invoke(null, new Object[]{entity.str});
            } catch (Exception e) {
                e.printStackTrace();
            }

            // ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹
            for (int i = 1; i &lt; entity.strArr.length; i++) {
                futureScheduler.scheduleFuture(new DaemonRunnable(this, i));
            }

            Logger.v(Logger.TAG, &quot;[&quot; + entity.str + &quot;] wait file lock start&quot;);
            NativeKeepAlive.waitFileLock(entity.strArr[0]);
            Logger.v(Logger.TAG, &quot;[&quot; + entity.str + &quot;] wait file lock finish&quot;);

            // æ–‡ä»¶é”é‡Šæ”¾ï¼Œç«‹å³æ‹‰æ´»
            startService();
            broadcastIntent();
            startInstrumentation();

            Logger.v(Logger.TAG, &quot;[&quot; + entity.str + &quot;] start android finish&quot;);
        } catch (Throwable th) {
            binderManager.thrown(th);
        }
    }
}
</code></pre>

<h3>å¯åŠ¨Service</h3>

<pre><code>public void startService() {
    Logger.i(Logger.TAG, &quot;call startService(): &quot; + p);
    if (p != null) {
        try {
            binder.transact(binderManager.startService(), p, null, 1);
        } catch (Throwable th) {
            binderManager.thrown(th);
        }
    }
}
</code></pre>

<h3>å‘é€å¹¿æ’­</h3>

<pre><code>public void broadcastIntent() {
    Logger.i(Logger.TAG, &quot;call broadcastIntent(): &quot; + p2);
    if (p2 != null) {
        try {
            binder.transact(binderManager.broadcastIntent(), p2, null, 1);
        } catch (Throwable th) {
            binderManager.thrown(th);
        }
    }
}
</code></pre>

<h3>ç»„è£…Parcelæ•°æ®</h3>

<pre><code>private void assembleServiceParcel() {
    p = Parcel.obtain();
    p.writeInterfaceToken(&quot;android.app.IActivityManager&quot;);
    p.writeStrongBinder(null);

    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {
        p.writeInt(1);
    }

    entity.intent.writeToParcel(p, 0);
    p.writeString(null);

    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {
        p.writeInt(0);
    }

    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
        p.writeString(entity.intent.getComponent().getPackageName());
    }

    p.writeInt(0);
}

@SuppressLint(&quot;WrongConstant&quot;)
private void assembleBroadcastParcel() {
    p2 = Parcel.obtain();
    p2.writeInterfaceToken(&quot;android.app.IActivityManager&quot;);
    p2.writeStrongBinder(null);

    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {
        p2.writeInt(1);
    }

    entity.intent2.setFlags(32);
    entity.intent2.writeToParcel(p2, 0);
    p2.writeString(null);
    p2.writeStrongBinder(null);
    p2.writeInt(-1);
    p2.writeString(null);
    p2.writeInt(0);
    p2.writeStringArray(null);
    p2.writeInt(-1);
    p2.writeInt(0);
    p2.writeInt(0);
    p2.writeInt(0);
    p2.writeInt(0);
}
</code></pre>

<h3>Nativeå±‚æ ¸å¿ƒæ–¹æ³•</h3>

<pre><code>void keep_alive_set_sid(JNIEnv *env, jclass jclazz) {
    setsid();  // è„±ç¦»çˆ¶è¿›ç¨‹ä¼šè¯ç»„
}
</code></pre>

<h3>å®ˆæŠ¤çº¿ç¨‹å®ç°</h3>

<pre><code>class DaemonRunnable implements Runnable {
    private WeakReference&lt;DaemonMain&gt; thiz;
    private int index;

    private DaemonRunnable(DaemonMain thiz, int index) {
        this.thiz = new WeakReference&lt;&gt;(thiz);
        this.index = index;
    }

    @Override
    public void run() {
        Logger.v(Logger.TAG, &quot;[Thread] wait file lock start: &quot; + index);
        NativeKeepAlive.waitFileLock(thiz.get().entity.strArr[index]);
        Logger.v(Logger.TAG, &quot;[Thread] wait file lock finished&quot;);

        // æ£€æµ‹åˆ°è¿›ç¨‹è¢«æ€ï¼Œç«‹å³æ‹‰æ´»
        thiz.get().startService();
        thiz.get().broadcastIntent();
        thiz.get().startInstrumentation();

        Logger.v(Logger.TAG, &quot;[Thread] start android finish&quot;);
    }
}
</code></pre>

<h2>Process.killProcessçš„ç§˜å¯†</h2>
<p>ä¸ºä»€ä¹ˆåœ¨æ‹‰æ´»åè¿˜è¦è°ƒç”¨<code>Process.killProcess(Process.myPid())</code>ï¼Ÿ</p>
<p><strong>åŸç†è§£æ</strong>ï¼š</p>
<ol>
<li><code>Process.killProcess</code>æœ€ç»ˆè°ƒç”¨Linux API <code>kill()</code>å‘é€<strong>SIGKILL</strong>ä¿¡å·</li>
<li>æ™®é€šè¿›ç¨‹æ”¶åˆ°SIGKILLä¼šç«‹å³ç»“æŸ</li>
<li><strong>ä½†Androidä¸åŒ</strong>ï¼šActivityManagerä¸€ç›´ç›‘å¬è¿›ç¨‹çŠ¶æ€</li>
<li>å‘ç°è¿›ç¨‹è¢«killåï¼Œä¼š<strong>ç«‹å³é‡å¯è¿›ç¨‹</strong></li>
<li>å¹¶é‡å¯ä¹‹å‰çš„Activityã€Serviceã€ContentProviderç­‰ç»„ä»¶</li>
</ol>
<p>è¿™ç¡®ä¿äº†è¿›ç¨‹è¢«é‡æ–°å¯åŠ¨ï¼Œè€Œä¸æ˜¯å½»åº•è¢«æ€æ­»ï¼Œå®ç°äº†<strong>æœ€å¤§ç¨‹åº¦çš„ä¿æ´»</strong>ã€‚</p>
<h2>å…³é”®æŠ€æœ¯ç‚¹æ€»ç»“</h2>
<h3>1. å¤šè¿›ç¨‹æ¶æ„</h3>
<ul>
<li>ä¸»è¿›ç¨‹ + å®ˆæŠ¤è¿›ç¨‹ + è¾…åŠ©è¿›ç¨‹</li>
<li>è¿›ç¨‹é—´æ–‡ä»¶é”äº’ç›¸ç›‘å¬</li>
<li>ä»»ä¸€è¿›ç¨‹è¢«æ€ï¼Œå…¶ä»–è¿›ç¨‹ç«‹å³æ‹‰æ´»</li>
</ul>
<h3>2. Binderæœºåˆ¶</h3>
<ul>
<li>åå°„è·å–ActivityManagerServiceçš„Binder</li>
<li>é¢„å…ˆåˆ›å»ºParcelé¿å…ä¸´æ—¶åˆ›å»ºè€—æ—¶</li>
<li>ç›´æ¥é€šè¿‡Binder.transact()å¯åŠ¨ç»„ä»¶</li>
</ul>
<h3>3. Nativeå±‚å®ˆæŠ¤</h3>
<ul>
<li>ä½¿ç”¨Cè¯­è¨€å®ç°æ–‡ä»¶é”æœºåˆ¶</li>
<li><code>setsid()</code>è„±ç¦»çˆ¶è¿›ç¨‹æ§åˆ¶</li>
<li>é˜»å¡ç­‰å¾…æ–‡ä»¶é”é‡Šæ”¾</li>
</ul>
<h3>4. Linuxè¿›ç¨‹æœºåˆ¶</h3>
<ul>
<li>é€šè¿‡app_processåœ¨Linuxå±‚å¯åŠ¨Javaè¿›ç¨‹</li>
<li>é…ç½®CLASSPATHå’ŒLD_LIBRARY_PATH</li>
<li>åˆ©ç”¨ActivityManagerçš„è¿›ç¨‹é‡å¯æœºåˆ¶</li>
</ul>
<h3>5. å¤šé‡æ‹‰æ´»</h3>
<ul>
<li>Serviceæ‹‰æ´»</li>
<li>Broadcastæ‹‰æ´»</li>
<li>Instrumentationæ‹‰æ´»</li>
<li>ä¸‰é‡ä¿éšœç¡®ä¿è¿›ç¨‹é‡å¯</li>
</ul>
<h2>é€‚ç”¨åœºæ™¯</h2>
<p>âš ï¸ <strong>é‡è¦æç¤º</strong>ï¼šæœ¬æŠ€æœ¯æ–¹æ¡ˆä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œç¦æ­¢ç”¨äºéæ³•ç”¨é€”ã€‚</p>
<h3>åˆæ³•ä½¿ç”¨åœºæ™¯</h3>
<ul>
<li>ğŸ“± å³æ—¶é€šè®¯åº”ç”¨çš„æ¶ˆæ¯æ¨é€</li>
<li>ğŸµ éŸ³ä¹æ’­æ”¾å™¨çš„åå°æ’­æ”¾</li>
<li>ğŸƒ è¿åŠ¨å¥åº·åº”ç”¨çš„è®¡æ­¥æœåŠ¡</li>
<li>ğŸ“ å®šä½å¯¼èˆªåº”ç”¨çš„ä½ç½®æ›´æ–°</li>
<li>â° é—¹é’Ÿæé†’åº”ç”¨çš„åå°å®ˆæŠ¤</li>
</ul>
<h3>æ³¨æ„äº‹é¡¹</h3>

<pre><code>// âš ï¸ å¦‚æœtargetSdkä¸º31ï¼Œéœ€è¦æ·»åŠ exportedå£°æ˜
// AndroidManifest.xmlä¸­çš„AutoBootReceiveréœ€è¦å¢åŠ ï¼š
android:exported=&quot;true&quot;
</code></pre>

<h2>æŠ€æœ¯è¦ç‚¹</h2>
<ol>
<li><strong>æ–‡ä»¶é”</strong>ï¼šNativeå±‚å®ç°ï¼ŒJavaå±‚æ— æ³•å®Œæˆ</li>
<li><strong>Binderä¼˜åŒ–</strong>ï¼šé¢„åˆ›å»ºParcelï¼Œåå°„è·å–Binder</li>
<li><strong>å¹¿æ’­æ‹‰æ´»</strong>ï¼šbinder transcateæ— æ³•ç›´æ¥å¯åŠ¨Service</li>
<li><strong>æ•°æ®ä¼ è¾“</strong>ï¼šä¼ è¾“u8æ•°æ®è€Œéç›´æ¥ä¼ é€’parcelé¿å…ç›‘å¬å¤±æ•ˆ</li>
<li><strong>è¿›ç¨‹è„±ç¦»</strong>ï¼šsetsid()æˆä¸ºæ–°ä¼šè¯é¢†å¤´è¿›ç¨‹</li>
</ol>
<h2>æºç å‚è€ƒ</h2>
<p>å®Œæ•´æºç å®ç°è¯·å‚è€ƒï¼š<a>GitHub - Pangu-Immortal</a></p>
<h2>ç›¸å…³æŠ€æœ¯æ–‡æ¡£</h2>
<ul>
<li><a>Android Instrumentationå®˜æ–¹æ–‡æ¡£</a></li>
<li>ActivityManagerè¿›ç¨‹ç®¡ç†æœºåˆ¶</li>
<li>Linuxæ–‡ä»¶é”ä¸è¿›ç¨‹åŒæ­¥</li>
<li>Android Binderé€šä¿¡æœºåˆ¶</li>
</ul>


<p><strong>å…è´£å£°æ˜</strong>ï¼šæœ¬æ–‡å†…å®¹ä»…ä¾›æŠ€æœ¯å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºä»»ä½•éæ³•ç”¨é€”ã€‚å¼€å‘è€…åº”éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„å’Œåº”ç”¨å•†åº—è§„èŒƒï¼Œåˆç†ä½¿ç”¨è¿›ç¨‹ä¿æ´»æŠ€æœ¯ã€‚</p>
            </div>
        </div>
    </article>
</div>

    </div>

    <!-- é¡µè„š -->
    <footer>Â© ç›˜å¤å¤§ä»™æ´åºœ - åŸºäº Django MTV æ¨¡å¼æ„å»º</footer>

    <!-- å­—æ¯é›¨è„šæœ¬ -->
    <script>
    (function() {
        const canvas = document.getElementById('matrix-canvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+*/#@$&'.split('');

        let dims = { w: 0, h: 0, dpr: 1, fontSize: 16 };
        let drops = [];
        let lastTime = 0;
        const targetFPS = 60;
        const frameInterval = 1000 / targetFPS;

        function setup() {
            dims = {
                w: window.innerWidth,
                h: window.innerHeight,
                dpr: window.devicePixelRatio || 1,
                fontSize: Math.max(14, Math.floor(window.innerWidth / 100))
            };

            canvas.width = dims.w * dims.dpr;
            canvas.height = dims.h * dims.dpr;
            ctx.setTransform(dims.dpr, 0, 0, dims.dpr, 0, 0);

            const columns = Math.floor(dims.w / dims.fontSize);
            drops = Array(columns).fill(0).map(() => Math.random() * -dims.h / dims.fontSize);
        }

        function draw(currentTime) {
            if (currentTime - lastTime < frameInterval) {
                requestAnimationFrame(draw);
                return;
            }
            lastTime = currentTime;

            ctx.fillStyle = 'rgba(3, 6, 12, 0.08)';
            ctx.fillRect(0, 0, dims.w, dims.h);

            ctx.font = dims.fontSize + 'px "JetBrains Mono", "SFMono-Regular", "Menlo", monospace';

            drops.forEach((y, index) => {
                for (let i = 0; i < 3; i++) {
                    const charY = (y - i * 2) * dims.fontSize;
                    if (charY > 0 && charY < dims.h) {
                        const text = chars[Math.floor(Math.random() * chars.length)];
                        const x = index * dims.fontSize;
                        const opacity = i === 0 ? 0.95 : 0.7 - (i * 0.2);
                        const brightness = i === 0 ? 75 : 65 - (i * 10);

                        ctx.fillStyle = `hsla(${190 + (index % 40)}, 90%, ${brightness}%, ${opacity})`;
                        ctx.fillText(text, x, charY);
                    }
                }

                if (y * dims.fontSize > dims.h + dims.fontSize * 5) {
                    drops[index] = Math.random() > 0.98 ? Math.random() * -dims.h / dims.fontSize : -dims.fontSize;
                } else {
                    drops[index] += 0.5 + Math.random() * 0.7;
                }
            });

            requestAnimationFrame(draw);
        }

        setup();

        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(setup, 100);
        });

        requestAnimationFrame(draw);
    })();
    </script>
</body>
</html>
