# 前后端交互问题修复方案

## 问题诊断

### 已发现的问题

1. **Vite代理端口配置错误**
   - 原配置：`http://127.0.0.1:7011`
   - Django实际运行端口：`8000`
   - **修复**：已更新 `frontend/vite.config.ts` 中的代理目标为 `http://127.0.0.1:8000`

2. **API接口不支持JSON格式**
   - 原实现：只支持 `request.POST` (form-data)
   - Vue前端通常使用 `application/json`
   - **修复**：已更新 `api_submit_comment` 和 `api_submit_message` 支持JSON和form-data两种格式

3. **缺少CORS响应头**
   - 跨域请求可能被浏览器阻止
   - **修复**：添加了 `cors_headers` 装饰器，为所有API响应添加CORS头

4. **首页字母雨效果未全屏**
   - 原实现：只覆盖部分区域
   - **修复**：已更新为全屏固定定位，从顶部到底部完全覆盖

## 修复内容清单

### 1. 前端配置修复

**文件：`frontend/vite.config.ts`**
- ✅ 代理目标端口：`7011` → `8000`
- ✅ 添加 `/media` 代理路径
- ✅ 前端端口统一为 `5173`

### 2. 后端API修复

**文件：`app/api_views.py`**
- ✅ 添加 `cors_headers` 装饰器
- ✅ 所有API接口支持 `OPTIONS` 预检请求
- ✅ `api_submit_comment` 支持JSON格式
- ✅ `api_submit_message` 支持JSON格式
- ✅ 评论和留言接口复用昵称/头像缓存逻辑

### 3. 首页动效修复

**文件：`templates/index.html`**
- ✅ 字母雨背景改为 `position: fixed`，全屏覆盖
- ✅ 内容层使用 `z-index` 确保在背景之上

**文件：`frontend/src/views/HomeView.vue`**
- ✅ 简化结构，依赖 `MatrixBackground` 组件提供全屏背景
- ✅ 内容居中显示，按钮可点击

## 验证步骤

### 1. 启动服务

```bash
# 后端
conda activate RunProject
cd /Users/qihao/PycharmProjects/RunProject
python manage.py runserver 8000

# 前端（新终端）
cd frontend
npm run dev
```

### 2. 测试API接口

#### 测试文章列表
```bash
curl http://127.0.0.1:8000/api/articles/
```

#### 测试评论提交（JSON格式）
```bash
curl -X POST http://127.0.0.1:8000/api/comments/submit/ \
  -H "Content-Type: application/json" \
  -d '{"article_id": 1, "content": "测试评论"}'
```

#### 测试留言提交（JSON格式）
```bash
curl -X POST http://127.0.0.1:8000/api/board/submit/ \
  -H "Content-Type: application/json" \
  -d '{"content": "测试留言"}'
```

### 3. 浏览器测试

1. 打开 `http://127.0.0.1:5173/`
2. 打开浏览器开发者工具（F12）
3. 查看 Network 标签：
   - 检查 `/api/` 请求是否成功（状态码200）
   - 检查响应头是否包含 `Access-Control-Allow-Origin: *`
   - 检查是否有CORS错误

### 4. 常见问题排查

#### 问题1：API返回404
- **原因**：URL路径不匹配
- **解决**：检查 `app/urls.py` 中的路由配置
- **验证**：访问 `http://127.0.0.1:8000/api/articles/` 应该返回JSON数据

#### 问题2：CORS错误
- **原因**：浏览器阻止跨域请求
- **解决**：确认已添加 `cors_headers` 装饰器
- **验证**：检查响应头是否包含 `Access-Control-Allow-Origin`

#### 问题3：JSON解析失败
- **原因**：Content-Type不正确
- **解决**：前端请求时设置 `Content-Type: application/json`
- **验证**：检查请求头中的 `Content-Type`

#### 问题4：代理不工作
- **原因**：Vite代理配置错误或后端未启动
- **解决**：
  1. 确认后端运行在 `8000` 端口
  2. 确认 `vite.config.ts` 中的代理目标正确
  3. 重启Vite开发服务器

## 下一步优化建议

1. **添加API标签接口**
   - 创建 `/api/tags/` 接口，返回所有标签列表

2. **完善错误处理**
   - 统一错误响应格式
   - 添加详细的错误信息

3. **添加请求限流**
   - 防止API被滥用
   - 使用 `django-ratelimit` 或自定义中间件

4. **添加API文档**
   - 使用 `drf-yasg` 或 `django-rest-framework` 生成API文档

5. **前端错误处理**
   - 统一处理API错误
   - 显示友好的错误提示

## 相关文件

- `frontend/vite.config.ts` - Vite代理配置
- `app/api_views.py` - API视图实现
- `app/urls.py` - URL路由配置
- `templates/index.html` - Django首页模板
- `frontend/src/views/HomeView.vue` - Vue首页组件

