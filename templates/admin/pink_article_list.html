{% extends "admin/pink_base.html" %}
{% load i18n admin_urls static admin_list %}

{% block title %}æ–‡ç« ç®¡ç† - ç›˜å¤å¤§ä»™æ´åºœ{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'custom_admin:index' %}">ğŸŒ¸ ç›˜å¤å¤§ä»™æ´åºœåå°</a></h1>
{% endblock %}

{% block content_title %}<h1>ğŸ“‹ æ–‡ç« ç®¡ç†</h1>{% endblock %}

{% block content %}
<!-- é¢åŒ…å±‘å¯¼èˆª -->
<nav class="breadcrumb">
    <a href="{% url 'custom_admin:index' %}">ğŸ  åå°é¦–é¡µ</a>
    <span class="separator">â€º</span>
    <span class="current">æ–‡ç« ç®¡ç†</span>
    <div style="margin-left: auto;">
        <a href="{% url 'custom_admin:index' %}" style="color: var(--pink-primary); text-decoration: none; font-size: 12px;">â† è¿”å›é¦–é¡µ</a>
    </div>
</nav>

<div class="article-list-container">
    <!-- æ“ä½œæ  -->
    <div class="action-bar">
        <div class="action-buttons">
            <a href="{% url 'custom_admin:app_article_add' %}" class="add-button">
                <span>âœ¨</span>
                æ–°å»ºæ–‡ç« 
            </a>
            <button type="button" class="bulk-action-btn" onclick="showBulkActions()">
                <span>âš¡</span>
                æ‰¹é‡æ“ä½œ
            </button>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ–‡ç« æ ‡é¢˜..." onkeyup="searchArticles()">
        </div>
    </div>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    <div class="articles-table">
        {% if cl.result_count > 0 %}
        <table>
            <thead>
                <tr>
                    <th class="checkbox-column">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th class="cover-column">å°é¢</th>
                    <th class="title-column">æ ‡é¢˜</th>
                    <th class="tags-column">æ ‡ç­¾</th>
                    <th class="status-column">çŠ¶æ€</th>
                    <th class="date-column">å‘å¸ƒæ—¶é—´</th>
                    <th class="actions-column">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="articlesTableBody">
                {% for article in cl.result_list %}
                <tr class="article-row" data-title="{{ article.title|lower }}" data-id="{{ article.pk }}" 
                    onclick="window.location='{% url 'custom_admin:app_article_change' article.pk %}'" 
                    style="cursor: pointer;">
                    <td class="checkbox-column">
                        <input type="checkbox" name="selected" value="{{ article.pk }}" onclick="event.stopPropagation()">
                    </td>
                    <td class="cover-column">
                        {% if article.cover %}
                            <img src="{{ article.cover.url }}" alt="å°é¢" class="cover-thumb">
                        {% else %}
                            <div class="no-cover">æ— å°é¢</div>
                        {% endif %}
                    </td>
                    <td class="title-column">
                        <div class="article-title">
                            <a href="{% url 'custom_admin:app_article_change' article.pk %}" class="title-link">
                                {{ article.title }}
                            </a>
                            {% if article.is_hidden %}
                                <span class="status-badge hidden">éšè—</span>
                            {% else %}
                                <span class="status-badge published">å·²å‘å¸ƒ</span>
                            {% endif %}
                            {% if not article.allow_comment %}
                                <span class="status-badge no-comment">ç¦è¯„</span>
                            {% endif %}
                        </div>
                        <div class="article-excerpt">
                            {{ article.content_md|truncatewords:20|striptags }}
                        </div>
                    </td>
                    <td class="tags-column">
                        {% if article.tags.all %}
                            <div class="tags-container">
                                {% for tag in article.tags.all %}
                                    <span class="tag">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="no-tags">æ— æ ‡ç­¾</span>
                        {% endif %}
                    </td>
                    <td class="status-column">
                        <div class="status-info">
                            <span class="status-indicator {% if article.is_hidden %}status-hidden{% else %}status-published{% endif %}"></span>
                            <span class="status-text">{{ article.get_is_hidden_display }}</span>
                        </div>
                        <div class="comment-status">
                            {% if article.allow_comment %}
                                <span class="comment-enabled">ğŸ’¬ å…è®¸è¯„è®º</span>
                            {% else %}
                                <span class="comment-disabled">ğŸš« ç¦æ­¢è¯„è®º</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="date-column">
                        <div class="publish-date">
                            {{ article.published_at|date:"Y-m-d" }}
                        </div>
                        <div class="publish-time">
                            {{ article.published_at|date:"H:i" }}
                        </div>
                    </td>
                    <td class="actions-column">
                        <div class="action-buttons">
                            <a href="{% url 'custom_admin:app_article_change' article.pk %}" class="edit-btn" title="ç¼–è¾‘" onclick="event.stopPropagation()">
                                âœï¸
                            </a>
                            <a href="{% url 'custom_admin:app_article_delete' article.pk %}" class="delete-btn" title="åˆ é™¤" 
                               onclick="event.stopPropagation(); return confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')">
                                ğŸ—‘ï¸
                            </a>
                            <a href="/articles/{{ article.pk }}/" target="_blank" class="view-btn" title="æŸ¥çœ‹" onclick="event.stopPropagation()">
                                ğŸ‘ï¸
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“</div>
            <h3>è¿˜æ²¡æœ‰æ–‡ç« </h3>
            <p>å¼€å§‹åˆ›ä½œä½ çš„ç¬¬ä¸€ç¯‡æ–‡ç« å§ï¼</p>
            <a href="{% url 'custom_admin:app_article_add' %}" class="add-button">
                <span>âœ¨</span>
                æ–°å»ºæ–‡ç« 
            </a>
        </div>
        {% endif %}
    </div>

    <!-- æ‰¹é‡æ“ä½œé¢æ¿ -->
    <div id="bulkActions" class="bulk-actions-panel" style="display: none;">
        <h3>âš¡ æ‰¹é‡æ“ä½œ</h3>
        <div class="bulk-actions">
            <button type="button" onclick="bulkAction('publish')" class="bulk-btn bulk-publish">
                <span>ğŸŒŸ</span>
                æ‰¹é‡å‘å¸ƒ
            </button>
            <button type="button" onclick="bulkAction('hide')" class="bulk-btn bulk-hide">
                <span>ğŸ™ˆ</span>
                æ‰¹é‡éšè—
            </button>
            <button type="button" onclick="bulkAction('enable_comment')" class="bulk-btn bulk-enable-comment">
                <span>ğŸ’¬</span>
                å¼€å¯è¯„è®º
            </button>
            <button type="button" onclick="bulkAction('disable_comment')" class="bulk-btn bulk-disable-comment">
                <span>ğŸš«</span>
                å…³é—­è¯„è®º
            </button>
            <button type="button" onclick="bulkAction('delete')" class="bulk-btn bulk-delete">
                <span>ğŸ—‘ï¸</span>
                æ‰¹é‡åˆ é™¤
            </button>
        </div>
        <button type="button" onclick="hideBulkActions()" class="cancel-btn">å–æ¶ˆ</button>
    </div>
</div>

<style>
/* é¢åŒ…å±‘å¯¼èˆª */
.breadcrumb {
    max-width: 1400px;
    margin: 0 auto 20px;
    padding: 15px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px var(--shadow-soft);
    border: 1px solid var(--pink-lighter);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    position: relative;
}

.breadcrumb a {
    color: var(--pink-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
}

.breadcrumb a:hover {
    color: var(--pink-dark);
    text-decoration: underline;
}

.breadcrumb .separator {
    color: var(--text-light);
    font-weight: bold;
}

.breadcrumb .current {
    color: var(--text-dark);
    font-weight: 600;
}

.article-list-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

/* æ“ä½œæ  */
.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px var(--shadow-soft);
    border: 1px solid var(--pink-lighter);
}

.action-buttons {
    display: flex;
    gap: 15px;
    align-items: center;
}

.add-button {
    background: var(--gradient-pink);
    color: white;
    text-decoration: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px var(--shadow-pink);
    display: flex;
    align-items: center;
    gap: 8px;
}

.add-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--shadow-pink);
    color: white;
    text-decoration: none;
}

.bulk-action-btn {
    background: var(--warm-gray);
    color: var(--text-dark);
    border: 1px solid var(--pink-lighter);
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.bulk-action-btn:hover {
    background: var(--pink-lighter);
    border-color: var(--pink-light);
}

.search-box input {
    border: 2px solid var(--pink-lighter);
    border-radius: 8px;
    padding: 12px 16px;
    width: 300px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.search-box input:focus {
    border-color: var(--pink-primary);
    box-shadow: 0 0 0 3px var(--shadow-pink);
    outline: none;
}

/* æ–‡ç« è¡¨æ ¼ */
.articles-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px var(--shadow-soft);
    border: 1px solid var(--pink-lighter);
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead th {
    background: var(--gradient-pink);
    color: white;
    font-weight: 600;
    padding: 16px;
    text-align: left;
    border-bottom: 2px solid var(--pink-light);
}

tbody tr {
    border-bottom: 1px solid var(--pink-lighter);
    transition: background 0.3s ease;
}

tbody tr:hover {
    background: var(--pink-lighter);
}

tbody td {
    padding: 16px;
    vertical-align: top;
}

/* åˆ—æ ·å¼ */
.checkbox-column {
    width: 40px;
    text-align: center;
}

.cover-column {
    width: 80px;
}

.cover-thumb {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 2px 8px var(--shadow-soft);
}

.no-cover {
    width: 60px;
    height: 60px;
    background: var(--pink-lighter);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 0.8rem;
}

.title-column {
    min-width: 300px;
}

.article-title {
    margin-bottom: 8px;
}

.title-link {
    color: var(--text-dark);
    font-weight: 600;
    text-decoration: none;
    font-size: 1.1rem;
    transition: color 0.3s ease;
}

.title-link:hover {
    color: var(--pink-primary);
    text-decoration: underline;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 8px;
}

.status-badge.published {
    background: #e8f5e8;
    color: #4caf50;
}

.status-badge.hidden {
    background: #ffeaea;
    color: #f44336;
}

.status-badge.no-comment {
    background: #fff3e0;
    color: #ff9800;
}

.article-excerpt {
    color: var(--text-medium);
    font-size: 0.9rem;
    line-height: 1.4;
    margin-top: 8px;
}

.tags-column {
    min-width: 150px;
}

.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.tag {
    background: var(--pink-lighter);
    color: var(--pink-dark);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.no-tags {
    color: var(--text-light);
    font-style: italic;
    font-size: 0.9rem;
}

.status-column {
    min-width: 120px;
}

.status-info {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-indicator.status-published {
    background: #4caf50;
}

.status-indicator.status-hidden {
    background: #f44336;
}

.status-text {
    font-weight: 500;
    font-size: 0.9rem;
}

.comment-status {
    font-size: 0.8rem;
    color: var(--text-light);
}

.comment-enabled {
    color: #4caf50;
}

.comment-disabled {
    color: #f44336;
}

.date-column {
    min-width: 100px;
    text-align: center;
}

.publish-date {
    font-weight: 500;
    color: var(--text-dark);
}

.publish-time {
    font-size: 0.8rem;
    color: var(--text-light);
}

.actions-column {
    width: 120px;
    text-align: center;
}

.action-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.edit-btn, .delete-btn, .view-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.edit-btn {
    background: #e3f2fd;
    color: #2196f3;
}

.edit-btn:hover {
    background: #2196f3;
    color: white;
    transform: translateY(-1px);
}

.delete-btn {
    background: #ffebee;
    color: #f44336;
}

.delete-btn:hover {
    background: #f44336;
    color: white;
    transform: translateY(-1px);
}

.view-btn {
    background: #f3e5f5;
    color: #9c27b0;
}

.view-btn:hover {
    background: #9c27b0;
    color: white;
    transform: translateY(-1px);
}

/* ç©ºçŠ¶æ€ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: var(--text-dark);
    margin-bottom: 10px;
    font-size: 1.5rem;
}

.empty-state p {
    margin-bottom: 30px;
    font-size: 1.1rem;
}

/* æ‰¹é‡æ“ä½œé¢æ¿ */
.bulk-actions-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    border: 1px solid var(--pink-lighter);
    z-index: 1000;
    max-width: 500px;
    width: 90%;
}

.bulk-actions-panel h3 {
    color: var(--pink-dark);
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
}

.bulk-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.bulk-btn {
    background: var(--warm-gray);
    color: var(--text-dark);
    border: 1px solid var(--pink-lighter);
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

.bulk-btn:hover {
    background: var(--pink-lighter);
    border-color: var(--pink-light);
    transform: translateY(-1px);
}

.bulk-publish:hover { background: #e8f5e8; border-color: #4caf50; }
.bulk-hide:hover { background: #fff3e0; border-color: #ff9800; }
.bulk-enable-comment:hover { background: #e3f2fd; border-color: #2196f3; }
.bulk-disable-comment:hover { background: #ffebee; border-color: #f44336; }
.bulk-delete:hover { background: #ffebee; border-color: #f44336; }

.cancel-btn {
    background: var(--warm-gray);
    color: var(--text-dark);
    border: 1px solid var(--pink-lighter);
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    font-weight: 500;
}

.cancel-btn:hover {
    background: var(--pink-lighter);
}

@media (max-width: 768px) {
    .action-bar {
        flex-direction: column;
        gap: 20px;
    }
    
    .search-box input {
        width: 100%;
    }
    
    .articles-table {
        overflow-x: auto;
    }
    
    table {
        min-width: 800px;
    }
    
    .bulk-actions {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// æœç´¢åŠŸèƒ½
function searchArticles() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.article-row');
    
    rows.forEach(row => {
        const title = row.getAttribute('data-title');
        if (title.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// å…¨é€‰åŠŸèƒ½
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('input[name="selected"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// æ‰¹é‡æ“ä½œé¢æ¿
function showBulkActions() {
    const selectedCount = document.querySelectorAll('input[name="selected"]:checked').length;
    if (selectedCount === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æ–‡ç« ');
        return;
    }
    document.getElementById('bulkActions').style.display = 'block';
}

function hideBulkActions() {
    document.getElementById('bulkActions').style.display = 'none';
}

// æ‰¹é‡æ“ä½œ
function bulkAction(action) {
    const selected = document.querySelectorAll('input[name="selected"]:checked');
    const ids = Array.from(selected).map(cb => cb.value);
    
    if (ids.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æ–‡ç« ');
        return;
    }
    
    let confirmMessage = '';
    let actionUrl = '';
    
    switch(action) {
        case 'publish':
            confirmMessage = `ç¡®å®šè¦å‘å¸ƒé€‰ä¸­çš„ ${ids.length} ç¯‡æ–‡ç« å—ï¼Ÿ`;
            actionUrl = '{% url "admin:app_article_changelist" %}';
            break;
        case 'hide':
            confirmMessage = `ç¡®å®šè¦éšè—é€‰ä¸­çš„ ${ids.length} ç¯‡æ–‡ç« å—ï¼Ÿ`;
            actionUrl = '{% url "admin:app_article_changelist" %}';
            break;
        case 'enable_comment':
            confirmMessage = `ç¡®å®šè¦å¼€å¯é€‰ä¸­çš„ ${ids.length} ç¯‡æ–‡ç« çš„è¯„è®ºå—ï¼Ÿ`;
            actionUrl = '{% url "admin:app_article_changelist" %}';
            break;
        case 'disable_comment':
            confirmMessage = `ç¡®å®šè¦å…³é—­é€‰ä¸­çš„ ${ids.length} ç¯‡æ–‡ç« çš„è¯„è®ºå—ï¼Ÿ`;
            actionUrl = '{% url "admin:app_article_changelist" %}';
            break;
        case 'delete':
            confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
            actionUrl = '{% url "admin:app_article_changelist" %}';
            break;
    }
    
    if (confirm(confirmMessage)) {
        // è¿™é‡Œå¯ä»¥æ·»åŠ AJAXè¯·æ±‚æ¥å¤„ç†æ‰¹é‡æ“ä½œ
        alert(`å·²é€‰æ‹©å¯¹ ${ids.length} ç¯‡æ–‡ç« æ‰§è¡Œæ“ä½œï¼š${action}`);
        hideBulkActions();
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é€‰æ‹©çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="selected"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const selectAll = document.getElementById('selectAll');
            const allChecked = document.querySelectorAll('input[name="selected"]').length === 
                              document.querySelectorAll('input[name="selected"]:checked').length;
            selectAll.checked = allChecked;
        });
    });
});
</script>
{% endblock %}
