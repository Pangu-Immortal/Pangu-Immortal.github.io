{% extends "admin/pink_base.html" %}
{% load i18n static admin_urls %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}
{% block content_title %}{{ title }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
/* æ–‡ç« ç¼–è¾‘é¡µé¢ä¸“ç”¨æ ·å¼ - é€‚é…ç²‰è‰²ä¸»é¢˜ */

.form-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-lg);
}

.form-section {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
    box-shadow: 0 8px 32px var(--shadow-light);
}

.form-section h3 {
    color: var(--pink-primary);
    font-size: var(--text-xl);
    font-weight: 600;
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-lg);
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    color: var(--text-medium);
    font-weight: 500;
    margin-bottom: var(--space-sm);
    font-size: var(--text-base);
}

.form-label.required::after {
    content: " *";
    color: var(--coral);
}

/* ä½¿ç”¨ç²‰è‰²ä¸»é¢˜çš„è¡¨å•æ§ä»¶ */
.form-input, .form-textarea, .form-select {
    background: var(--bg-card);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    color: var(--text-dark);
    font-size: var(--text-base);
    transition: all 0.3s ease;
    width: 100%;
    min-height: 44px; /* è§¦æ‘¸å‹å¥½ */
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: var(--pink-primary);
    box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1), 0 0 20px rgba(255, 107, 157, 0.1);
    transform: translateY(-1px);
}

/* ä¼˜åŒ–å¤é€‰æ¡†æ ·å¼ - ç¼©å°å°ºå¯¸ */
.form-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
    cursor: pointer;
    user-select: none;
}

.form-checkbox input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--pink-primary);
    cursor: pointer;
    flex-shrink: 0;
}

.form-checkbox span {
    color: var(--text-medium);
    font-size: var(--text-base);
}

.form-hint {
    color: var(--text-light);
    font-size: var(--text-sm);
    margin-top: var(--space-xs);
}

/* æ–‡ä»¶ä¸Šä¼  */
.file-upload {
    position: relative;
    display: inline-block;
    width: 100%;
}

.file-input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.file-upload-btn {
    background: linear-gradient(135deg, var(--pink-primary) 0%, var(--pink-secondary) 100%);
    color: var(--text-white);
    border: none;
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
}

.file-upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px var(--shadow-medium);
}

.file-name {
    margin-left: var(--space-md);
    color: var(--text-light);
    font-size: var(--text-sm);
}

/* æ ‡ç­¾é€‰æ‹©å™¨ - ç°ä»£åŒ– */
.tag-selector {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1rem;
    align-items: start;
}

.tag-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: 0 4px 12px var(--shadow-light);
}

.tag-panel-header {
    background: linear-gradient(135deg, var(--pink-primary) 0%, var(--pink-secondary) 100%);
    color: var(--text-white);
    padding: var(--space-md);
    font-weight: 600;
    font-size: var(--text-sm);
}

.tag-search {
    width: 100%;
    background: var(--bg-secondary);
    border: none;
    border-bottom: 1px solid var(--border-light);
    padding: var(--space-sm) var(--space-md);
    color: var(--text-dark);
    font-size: var(--text-sm);
}

.tag-search::placeholder {
    color: var(--text-light);
}

.tag-list {
    max-height: 200px;
    overflow-y: auto;
    padding: var(--space-sm);
}

.tag-item {
    display: flex;
    align-items: center;
    padding: var(--space-sm);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: var(--text-sm);
    color: var(--text-dark);
}

.tag-item:hover {
    background: var(--bg-hover);
}

.tag-item.selected {
    background: var(--pink-lighter);
    border: 1px solid var(--pink-light);
    color: var(--pink-darker);
}

.tag-controls {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    padding: var(--space-md) 0;
}

.tag-btn {
    background: linear-gradient(135deg, var(--pink-primary) 0%, var(--pink-secondary) 100%);
    color: var(--text-white);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-weight: bold;
}

.tag-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px var(--shadow-medium);
}

/* Markdownç¼–è¾‘å™¨ - ä¸“ä¸šçº§ */
.markdown-editor {
    border: 1px solid rgba(56, 189, 248, 0.3);
    border-radius: 8px;
    overflow: hidden;
    background: rgba(15, 23, 42, 0.9);
    box-shadow: 0 4px 20px rgba(2, 8, 20, 0.3);
}

.markdown-toolbar {
    background: linear-gradient(135deg, #075985 0%, #0c4a6e 100%);
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
    border-bottom: 1px solid rgba(56, 189, 248, 0.2);
}

.markdown-btn {
    background: rgba(15, 23, 42, 0.8);
    color: #e2e8f0;
    border: 1px solid rgba(56, 189, 248, 0.3);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.markdown-btn:hover {
    background: rgba(56, 189, 248, 0.2);
    border-color: #06b6d4;
}

.markdown-btn.active {
    background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
    color: white;
    border-color: transparent;
}

.markdown-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    min-height: 500px;
}

.markdown-input, .markdown-preview {
    padding: 1rem;
    background: rgba(15, 23, 42, 0.9);
    border: none;
    color: #e2e8f0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 0.95rem;
    line-height: 1.6;
    resize: none;
    outline: none;
}

.markdown-input {
    border-right: 1px solid rgba(56, 189, 248, 0.2);
}

.markdown-preview {
    background: rgba(30, 41, 59, 0.9);
    overflow-y: auto;
}

.markdown-preview h1, .markdown-preview h2, .markdown-preview h3,
.markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
    color: #7dd3fc;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-preview code {
    background: rgba(56, 189, 248, 0.1);
    color: #7dd3fc;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.9em;
}

.markdown-preview pre {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(56, 189, 248, 0.2);
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
}

.markdown-preview blockquote {
    border-left: 4px solid #06b6d4;
    padding-left: 1rem;
    margin: 1rem 0;
    color: #94a3b8;
    font-style: italic;
}

.markdown-preview table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
}

.markdown-preview th, .markdown-preview td {
    border: 1px solid rgba(56, 189, 248, 0.2);
    padding: 0.5rem;
    text-align: left;
}

.markdown-preview th {
    background: rgba(56, 189, 248, 0.1);
    color: #7dd3fc;
    font-weight: 600;
}

/* æ“ä½œæŒ‰é’® */
.form-actions {
    display: flex;
    gap: var(--space-md);
    justify-content: flex-end;
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-light);
}

.btn {
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-lg);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-base);
}

.btn-primary {
    background: linear-gradient(135deg, var(--pink-primary) 0%, var(--pink-secondary) 100%);
    color: var(--text-white);
    box-shadow: 0 4px 15px var(--shadow-medium);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px var(--shadow-dark);
}

.btn-secondary {
    background: var(--warm-gray);
    color: var(--text-medium);
    border: 1px solid var(--border-medium);
}

.btn-secondary:hover {
    background: var(--bg-hover);
    color: var(--pink-darker);
    border-color: var(--pink-light);
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    color: var(--text-white);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
    .main-container {
        flex-direction: column;
        gap: var(--space-md);
    }
    
    .sidebar {
        width: 100%;
        position: static;
    }
    
    .tag-selector {
        grid-template-columns: 1fr;
    }
    
    .markdown-content {
        grid-template-columns: 1fr;
    }
    
    .markdown-input {
        border-right: none;
        border-bottom: 1px solid var(--border-light);
    }
}

@media (max-width: 768px) {
    .main-container {
        padding: var(--space-md);
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--warm-gray);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--pink-primary) 0%, var(--pink-secondary) 100%);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--pink-dark) 0%, var(--pink-primary) 100%);
}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <form method="post" enctype="multipart/form-data" id="article-form">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-error">
            {{ form.non_field_errors }}
        </div>
        {% endif %}
        
        <!-- æ–‡ç« å†…å®¹ -->
        <div class="form-section">
            <h3>ğŸ“ æ–‡ç« å†…å®¹</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}" class="form-label required">
                        ğŸ“– æ–‡ç« æ ‡é¢˜
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                    <div class="form-error">{{ form.title.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.subtitle.id_for_label }}" class="form-label">
                        ğŸ“ å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
                    </label>
                    {{ form.subtitle }}
                    <div class="form-hint">ç®€æ´çš„å‰¯æ ‡é¢˜ï¼Œå¸å¼•è¯»è€…æ³¨æ„åŠ›</div>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label required">
                        ğŸ“„ æ–‡ç« å†…å®¹ï¼ˆMarkdownï¼‰
                    </label>
                    <div class="markdown-editor">
                        <div class="markdown-toolbar">
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('**', '**')" title="åŠ ç²—">
                                <strong>B</strong>
                            </button>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('*', '*')" title="æ–œä½“">
                                <em>I</em>
                            </button>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('~~', '~~')" title="åˆ é™¤çº¿">
                                <s>S</s>
                            </button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('# ', '')" title="æ ‡é¢˜1">H1</button>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('## ', '')" title="æ ‡é¢˜2">H2</button>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('### ', '')" title="æ ‡é¢˜3">H3</button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('`', '`')" title="è¡Œå†…ä»£ç ">
                                <code>&lt;/&gt;</code>
                            </button>
                            <button type="button" class="markdown-btn" onclick="insertCodeBlock()" title="ä»£ç å—">
                                { }
                            </button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('- ', '')" title="æ— åºåˆ—è¡¨">â€¢ åˆ—è¡¨</button>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('1. ', '')" title="æœ‰åºåˆ—è¡¨">1. åˆ—è¡¨</button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('[', '](url)')" title="é“¾æ¥">ğŸ”—</button>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('![', '](image-url)')" title="å›¾ç‰‡">ğŸ–¼ï¸</button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="markdown-btn" onclick="insertTable()" title="è¡¨æ ¼">âŠ</button>
                            <button type="button" class="markdown-btn" onclick="insertMarkdown('---', '')" title="åˆ†éš”çº¿">â”€</button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="markdown-btn" onclick="toggleFullscreen()" title="å…¨å±">â›¶</button>
                            <button type="button" class="markdown-btn" onclick="clearContent()" title="æ¸…ç©º">ğŸ—‘ï¸</button>
                        </div>
                        <div class="markdown-content">
                            <textarea name="content_md" id="content_md" class="markdown-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥Markdownå†…å®¹...

æ”¯æŒè¯­æ³•ï¼š
- **åŠ ç²—æ–‡æœ¬**
- *æ–œä½“æ–‡æœ¬*
- `è¡Œå†…ä»£ç `
- æ ‡é¢˜ï¼š# ä¸€çº§æ ‡é¢˜
- åˆ—è¡¨ï¼š- é¡¹ç›®1
- é“¾æ¥ï¼š[é“¾æ¥æ–‡æœ¬](url)
- å›¾ç‰‡ï¼š![æè¿°](å›¾ç‰‡url)
- ä»£ç å—ï¼š```è¯­è¨€
ä»£ç å†…å®¹
```

æ›´å¤šåŠŸèƒ½è¯·ä½¿ç”¨å·¥å…·æ æŒ‰é’®ï¼">{{ form.content_md.value|default:"" }}</textarea>
                            <div class="markdown-preview" id="markdown-preview">
                                <div style="padding: 2rem; text-align: center; color: #94a3b8;">
                                    <p>ğŸ“ é¢„è§ˆåŒºåŸŸ</p>
                                    <p style="font-size: 0.9rem; margin-top: 1rem;">åœ¨å·¦ä¾§è¾“å…¥Markdownå†…å®¹ï¼Œè¿™é‡Œå°†å®æ—¶æ˜¾ç¤ºé¢„è§ˆæ•ˆæœ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if form.content_md.errors %}
                    <div class="form-error">{{ form.content_md.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- æ–‡ç« è®¾ç½® -->
        <div class="form-section">
            <h3>âš™ï¸ æ–‡ç« è®¾ç½®</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.cover.id_for_label }}" class="form-label">
                        ğŸ–¼ï¸ å°é¢å›¾ç‰‡
                    </label>
                    <div class="file-upload">
                        <input type="file" name="cover" id="{{ form.cover.id_for_label }}" class="file-input" accept="image/*" onchange="updateFileName(this)">
                        <button type="button" class="file-upload-btn">
                            ğŸ“ é€‰æ‹©å›¾ç‰‡
                        </button>
                        <span class="file-name" id="cover-file-name">
                            {% if form.instance.cover %}
                                {{ form.instance.cover.name }}
                            {% else %}
                                æœªé€‰æ‹©æ–‡ä»¶
                            {% endif %}
                        </span>
                    </div>
                    {% if form.cover.errors %}
                    <div class="form-error">{{ form.cover.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.published_at.id_for_label }}" class="form-label">
                        ğŸ“… å‘å¸ƒæ—¶é—´
                    </label>
                    {{ form.published_at }}
                    <div class="form-hint">æ–‡ç« æ˜¾ç¤ºçš„å‘å¸ƒæ—¶é—´</div>
                    {% if form.published_at.errors %}
                    <div class="form-error">{{ form.published_at.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        ğŸ·ï¸ æ–‡ç« æ ‡ç­¾
                    </label>
                    <div class="tag-selector">
                        <div class="tag-panel">
                            <div class="tag-panel-header">ğŸ“‹ å¯ç”¨æ ‡ç­¾</div>
                            <input type="text" class="tag-search" placeholder="ğŸ” æœç´¢æ ‡ç­¾..." onkeyup="filterTags(this, 'available-tags')">
                            <div class="tag-list" id="available-tags">
                                {% for tag in available_tags %}
                                <div class="tag-item" onclick="selectTag(this, '{{ tag.id }}', '{{ tag.name }}')" data-tag-id="{{ tag.id }}">
                                    {{ tag.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="tag-controls">
                            <button type="button" class="tag-btn" onclick="addSelectedTags()" title="æ·»åŠ é€‰ä¸­æ ‡ç­¾">â†’</button>
                            <button type="button" class="tag-btn" onclick="removeSelectedTags()" title="ç§»é™¤é€‰ä¸­æ ‡ç­¾">â†</button>
                        </div>
                        
                        <div class="tag-panel">
                            <div class="tag-panel-header">âœ… å·²é€‰æ ‡ç­¾</div>
                            <input type="text" class="tag-search" placeholder="ğŸ” æœç´¢å·²é€‰æ ‡ç­¾..." onkeyup="filterTags(this, 'selected-tags')">
                            <div class="tag-list" id="selected-tags">
                                {% for tag in selected_tags %}
                                <div class="tag-item selected" onclick="deselectTag(this, '{{ tag.id }}', '{{ tag.name }}')" data-tag-id="{{ tag.id }}">
                                    {{ tag.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="tags" id="selected-tags-input" value="{% for tag in selected_tags %}{{ tag.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                    {% if form.tags.errors %}
                    <div class="form-error">{{ form.tags.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- å‘å¸ƒé€‰é¡¹ -->
        <div class="form-section">
            <h3>ğŸ”’ å‘å¸ƒé€‰é¡¹</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" name="is_hidden" id="{{ form.is_hidden.id_for_label }}" {% if form.is_hidden.value %}checked{% endif %}>
                        ğŸ‘» éšè—æ–‡ç« 
                    </label>
                    <div class="form-hint">æ–‡ç« ä¸ä¼šåœ¨ç½‘ç«™å‰å°æ˜¾ç¤º</div>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                âŒ å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary" name="_save">
                ğŸ’¾ ä¿å­˜
            </button>
            <button type="submit" class="btn btn-success" name="_continue">
                ğŸ’¾ ä¿å­˜å¹¶ç»§ç»­ç¼–è¾‘
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
// Markdownç¼–è¾‘å™¨åŠŸèƒ½
let markdownInput = document.getElementById('content_md');
let markdownPreview = document.getElementById('markdown-preview');

// å®æ—¶é¢„è§ˆ
function updatePreview() {
    if (!markdownInput || !markdownPreview) return;
    
    let content = markdownInput.value;
    if (!content.trim()) {
        markdownPreview.innerHTML = '<div style="padding: 2rem; text-align: center; color: #94a3b8;"><p>ğŸ“ é¢„è§ˆåŒºåŸŸ</p><p style="font-size: 0.9rem; margin-top: 1rem;">åœ¨å·¦ä¾§è¾“å…¥Markdownå†…å®¹ï¼Œè¿™é‡Œå°†å®æ—¶æ˜¾ç¤ºé¢„è§ˆæ•ˆæœ</p></div>';
        return;
    }
    
    // é…ç½®markedé€‰é¡¹
    marked.setOptions({
        highlight: function(code, lang) {
            if (Prism && lang) {
                return Prism.highlight(code, Prism.languages[lang] || Prism.languages.markup, lang);
            }
            return code;
        },
        breaks: true,
        gfm: true
    });
    
    let html = marked.parse(content);
    markdownPreview.innerHTML = DOMPurify.sanitize(html);
}

// æ’å…¥Markdownè¯­æ³•
function insertMarkdown(before, after) {
    if (!markdownInput) return;
    
    let start = markdownInput.selectionStart;
    let end = markdownInput.selectionEnd;
    let selectedText = markdownInput.value.substring(start, end);
    let replacement = before + selectedText + after;
    
    markdownInput.value = markdownInput.value.substring(0, start) + replacement + markdownInput.value.substring(end);
    markdownInput.focus();
    markdownInput.setSelectionRange(start + before.length, start + before.length + selectedText.length);
    
    updatePreview();
}

// æ’å…¥ä»£ç å—
function insertCodeBlock() {
    insertMarkdown('```javascript\n', '\n```\n');
}

// æ’å…¥è¡¨æ ¼
function insertTable() {
    let table = '| æ ‡é¢˜1 | æ ‡é¢˜2 | æ ‡é¢˜3 |\n|-------|-------|-------|\n| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |\n';
    insertMarkdown(table, '');
}

// æ¸…ç©ºå†…å®¹
function clearContent() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
        markdownInput.value = '';
        updatePreview();
    }
}

// å…¨å±æ¨¡å¼
function toggleFullscreen() {
    let editor = document.querySelector('.markdown-editor');
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        editor.requestFullscreen();
    }
}

// æ–‡ä»¶ä¸Šä¼ å¤„ç†
function updateFileName(input) {
    let fileName = input.files[0]?.name || 'æœªé€‰æ‹©æ–‡ä»¶';
    document.getElementById('cover-file-name').textContent = fileName;
}

// æ ‡ç­¾é€‰æ‹©åŠŸèƒ½
function filterTags(input, listId) {
    let filter = input.value.toLowerCase();
    let items = document.querySelectorAll(`#${listId} .tag-item`);
    
    items.forEach(item => {
        let text = item.textContent.toLowerCase();
        if (text.includes(filter)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function selectTag(element, tagId, tagName) {
    element.classList.add('selected');
}

function deselectTag(element, tagId, tagName) {
    element.classList.remove('selected');
}

function addSelectedTags() {
    let selectedItems = document.querySelectorAll('#available-tags .tag-item.selected');
    let selectedList = document.getElementById('selected-tags');
    let selectedTags = [];
    
    selectedItems.forEach(item => {
        let tagId = item.dataset.tagId;
        let tagName = item.textContent;
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        let existing = selectedList.querySelector(`[data-tag-id="${tagId}"]`);
        if (!existing) {
            let newItem = item.cloneNode(true);
            newItem.classList.remove('selected');
            newItem.onclick = function() { deselectTag(this, tagId, tagName); };
            selectedList.appendChild(newItem);
            selectedTags.push(tagId);
        }
        item.classList.remove('selected');
    });
    
    updateSelectedTagsInput();
}

function removeSelectedTags() {
    let selectedItems = document.querySelectorAll('#selected-tags .tag-item.selected');
    
    selectedItems.forEach(item => {
        item.remove();
    });
    
    updateSelectedTagsInput();
}

function updateSelectedTagsInput() {
    let selectedItems = document.querySelectorAll('#selected-tags .tag-item');
    let tagIds = Array.from(selectedItems).map(item => item.dataset.tagId);
    document.getElementById('selected-tags-input').value = tagIds.join(',');
}

// åˆå§‹åŒ–
if (markdownInput) {
    markdownInput.addEventListener('input', updatePreview);
    markdownInput.addEventListener('scroll', function() {
        // åŒæ­¥æ»šåŠ¨ï¼ˆå¯é€‰ï¼‰
        let scrollPercentage = this.scrollTop / (this.scrollHeight - this.clientHeight);
        markdownPreview.scrollTop = scrollPercentage * (markdownPreview.scrollHeight - markdownPreview.clientHeight);
    });
    
    // åˆå§‹é¢„è§ˆ
    updatePreview();
}

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    // Ctrl + B åŠ ç²—
    if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        insertMarkdown('**', '**');
    }
    
    // Ctrl + I æ–œä½“
    if (e.ctrlKey && e.key === 'i') {
        e.preventDefault();
        insertMarkdown('*', '*');
    }
    
    // Ctrl + K é“¾æ¥
    if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        insertMarkdown('[', '](url)');
    }
    
    // Ctrl + S ä¿å­˜
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.querySelector('button[name="_save"]').click();
    }
});

// è¡¨å•æäº¤å¤„ç†
document.getElementById('article-form').addEventListener('submit', function(e) {
    // ç¡®ä¿æ ‡ç­¾æ•°æ®æ­£ç¡®æäº¤
    let selectedTags = document.getElementById('selected-tags-input').value;
    if (selectedTags) {
        let tagsArray = selectedTags.split(',').filter(id => id.trim());
        // åˆ›å»ºéšè—è¾“å…¥å­—æ®µ
        tagsArray.forEach(tagId => {
            let input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tags';
            input.value = tagId;
            this.appendChild(input);
        });
    }
});
</script>
{% endblock %}
